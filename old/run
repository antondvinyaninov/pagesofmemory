#!/bin/bash

# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ Memory
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./run [–∫–æ–º–∞–Ω–¥–∞]
# –ö–æ–º–∞–Ω–¥—ã: start, stop, restart, status, install

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND_DIR="$PROJECT_ROOT/backend"
FRONTEND_DIR="$PROJECT_ROOT/frontend"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${BLUE}[$(date +'%H:%M:%S')]${NC} $1"
}

success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

error() {
    echo -e "${RED}‚ùå $1${NC}"
}

warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ—Ä—Ç–æ–≤
kill_ports() {
    log "–û—á–∏—Å—Ç–∫–∞ –ø–æ—Ä—Ç–æ–≤ 3000 –∏ 5000..."
    
    # –ü–æ—Ä—Ç 3000 (Frontend)
    if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1; then
        log "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3000..."
        lsof -ti:3000 | xargs kill -9 2>/dev/null || true
    fi
    
    # –ü–æ—Ä—Ç 5000 (Backend)
    if lsof -Pi :5000 -sTCP:LISTEN -t >/dev/null 2>&1; then
        log "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 5000..."
        lsof -ti:5000 | xargs kill -9 2>/dev/null || true
    fi
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ –∏–º–µ–Ω–∞–º –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    pkill -f "next dev" 2>/dev/null || true
    pkill -f "ts-node-dev" 2>/dev/null || true
    pkill -f "node.*index.ts" 2>/dev/null || true
    pkill -f "npm run dev" 2>/dev/null || true
    
    sleep 2
    success "–ü–æ—Ä—Ç—ã –æ—á–∏—â–µ–Ω—ã"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check_dependencies() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js
    if ! command -v node &> /dev/null; then
        error "Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ npm
    if ! command -v npm &> /dev/null; then
        error "npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend
    if [ ! -d "$BACKEND_DIR/node_modules" ]; then
        warning "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ backend –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend
    if [ ! -d "$FRONTEND_DIR/node_modules" ]; then
        warning "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ frontend –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        return 1
    fi
    
    success "–í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞ –º–µ—Å—Ç–µ"
    return 0
}

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
install_dependencies() {
    log "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    # Backend
    log "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend..."
    cd "$BACKEND_DIR"
    npm install
    if [ $? -eq 0 ]; then
        success "Backend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    else
        error "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ backend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        exit 1
    fi
    
    # Frontend
    log "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend..."
    cd "$FRONTEND_DIR"
    npm install
    if [ $? -eq 0 ]; then
        success "Frontend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    else
        error "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ frontend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        exit 1
    fi
    
    cd "$PROJECT_ROOT"
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
setup_env() {
    log "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    
    # Backend
    if [ ! -f "$BACKEND_DIR/.env" ]; then
        if [ -f "$BACKEND_DIR/config.env" ]; then
            cp "$BACKEND_DIR/config.env" "$BACKEND_DIR/.env"
            success "Backend .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω"
        else
            warning "config.env –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ backend"
        fi
    fi
    
    # Frontend
    if [ ! -f "$FRONTEND_DIR/.env.local" ]; then
        if [ -f "$FRONTEND_DIR/config.env" ]; then
            cp "$FRONTEND_DIR/config.env" "$FRONTEND_DIR/.env.local"
            success "Frontend .env.local —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω"
        else
            warning "config.env –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ frontend"
        fi
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
check_status() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤..."
    
    # Backend
    if lsof -Pi :5000 -sTCP:LISTEN -t >/dev/null 2>&1; then
        success "Backend —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 5000"
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ health check
        if curl -s http://localhost:5000/health >/dev/null 2>&1; then
            success "Backend API –æ—Ç–≤–µ—á–∞–µ—Ç"
        else
            warning "Backend –∑–∞–ø—É—â–µ–Ω, –Ω–æ API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
        fi
    else
        error "Backend –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    fi
    
    # Frontend
    if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1; then
        success "Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3000"
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
        if curl -s -I http://localhost:3000 | head -1 | grep -q "200\|301\|302"; then
            success "Frontend –¥–æ—Å—Ç—É–ø–µ–Ω"
        else
            warning "Frontend –∑–∞–ø—É—â–µ–Ω, –Ω–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
        fi
    else
        error "Frontend –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    fi
}

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤
start_servers() {
    log "–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤..."
    
    # –û—á–∏—Å—Ç–∫–∞ –ø–æ—Ä—Ç–æ–≤
    kill_ports
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    if ! check_dependencies; then
        install_dependencies
    fi
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    setup_env
    
    # –°–±–æ—Ä–∫–∞ backend
    log "–°–±–æ—Ä–∫–∞ backend..."
    cd "$BACKEND_DIR"
    npm run build
    if [ $? -ne 0 ]; then
        error "–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ backend"
        exit 1
    fi
    
    # –ó–∞–ø—É—Å–∫ backend –≤ —Ñ–æ–Ω–µ
    log "–ó–∞–ø—É—Å–∫ backend –Ω–∞ –ø–æ—Ä—Ç—É 5000..."
    cd "$BACKEND_DIR"
    npm run dev > "$PROJECT_ROOT/backend.log" 2>&1 &
    BACKEND_PID=$!
    
    # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ backend
    log "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ backend..."
    for i in {1..30}; do
        if curl -s http://localhost:5000/health >/dev/null 2>&1; then
            success "Backend –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
            break
        fi
        if [ $i -eq 30 ]; then
            error "Backend –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∑–∞ 30 —Å–µ–∫—É–Ω–¥"
            kill $BACKEND_PID 2>/dev/null || true
            exit 1
        fi
        sleep 1
    done
    
    # –ó–∞–ø—É—Å–∫ frontend –≤ —Ñ–æ–Ω–µ
    log "–ó–∞–ø—É—Å–∫ frontend –Ω–∞ –ø–æ—Ä—Ç—É 3000..."
    cd "$FRONTEND_DIR"
    npm run dev > "$PROJECT_ROOT/frontend.log" 2>&1 &
    FRONTEND_PID=$!
    
    # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ frontend
    log "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ frontend..."
    for i in {1..60}; do
        if curl -s -I http://localhost:3000 >/dev/null 2>&1; then
            success "Frontend –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
            break
        fi
        if [ $i -eq 60 ]; then
            error "Frontend –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∑–∞ 60 —Å–µ–∫—É–Ω–¥"
            kill $FRONTEND_PID 2>/dev/null || true
            kill $BACKEND_PID 2>/dev/null || true
            exit 1
        fi
        sleep 1
    done
    
    cd "$PROJECT_ROOT"
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ PID –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    echo $BACKEND_PID > "$PROJECT_ROOT/.backend.pid"
    echo $FRONTEND_PID > "$PROJECT_ROOT/.frontend.pid"
    
    success "–ü—Ä–æ–µ–∫—Ç –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    echo ""
    log "üåê Frontend: http://localhost:3000"
    log "üîß Backend:  http://localhost:5000"
    log "üìä Health:   http://localhost:5000/health"
    echo ""
    log "–õ–æ–≥–∏ backend: $PROJECT_ROOT/backend.log"
    log "–õ–æ–≥–∏ frontend: $PROJECT_ROOT/frontend.log"
    echo ""
    warning "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ./run stop"
}

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
stop_servers() {
    log "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤..."
    
    # –ß–∏—Ç–∞–µ–º PID –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã
    if [ -f "$PROJECT_ROOT/.backend.pid" ]; then
        BACKEND_PID=$(cat "$PROJECT_ROOT/.backend.pid")
        kill $BACKEND_PID 2>/dev/null || true
        rm -f "$PROJECT_ROOT/.backend.pid"
    fi
    
    if [ -f "$PROJECT_ROOT/.frontend.pid" ]; then
        FRONTEND_PID=$(cat "$PROJECT_ROOT/.frontend.pid")
        kill $FRONTEND_PID 2>/dev/null || true
        rm -f "$PROJECT_ROOT/.frontend.pid"
    fi
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ—Ä—Ç–æ–≤
    kill_ports
    
    success "–°–µ—Ä–≤–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
case "${1:-start}" in
    "start")
        echo ""
        log "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ Memory..."
        echo ""
        start_servers
        ;;
    "stop")
        echo ""
        log "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ Memory..."
        echo ""
        stop_servers
        ;;
    "restart")
        echo ""
        log "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ Memory..."
        echo ""
        stop_servers
        sleep 2
        start_servers
        ;;
    "status")
        echo ""
        log "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ Memory..."
        echo ""
        check_status
        ;;
    "install")
        echo ""
        log "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
        echo ""
        install_dependencies
        setup_env
        success "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        ;;
    "ports"|"kill-ports")
        echo ""
        log "üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–Ω—è—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤..."
        echo ""
        kill_ports
        ;;
    *)
        echo ""
        echo "üîß Memory Project - –°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º"
        echo ""
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–∫–æ–º–∞–Ω–¥–∞]"
        echo ""
        echo "–ö–æ–º–∞–Ω–¥—ã:"
        echo "  start     - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
        echo "  stop      - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
        echo "  restart   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
        echo "  status    - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
        echo "  install   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
        echo "  ports     - –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–Ω—è—Ç—ã–µ –ø–æ—Ä—Ç—ã (3000, 5000)"
        echo "  kill-ports- –¢–æ –∂–µ, —á—Ç–æ –∏ ports"
        echo ""
        echo "–ü—Ä–∏–º–µ—Ä—ã:"
        echo "  $0           # –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞"
        echo "  $0 start     # –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞"
        echo "  $0 stop      # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞"
        echo "  $0 restart   # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞"
        echo "  $0 ports     # –û—á–∏—Å—Ç–∫–∞ –ø–æ—Ä—Ç–æ–≤ 3000 –∏ 5000"
        echo ""
        ;;
esac
