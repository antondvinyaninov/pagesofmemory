#!/bin/bash

set -e

LARAVEL_PORT=8000
VITE_PORT=5173
LOG_DIR="logs"
LARAVEL_LOG="$LOG_DIR/laravel.log"
VITE_LOG="$LOG_DIR/vite.log"

mkdir -p "$LOG_DIR"

echo "üöÄ –ó–∞–ø—É—Å–∫ Laravel –ø—Ä–æ–µ–∫—Ç–∞..."

check_port() {
    local port=$1
    lsof -ti:$port >/dev/null 2>&1
}

kill_port() {
    local port=$1
    local name=$2
    if check_port $port; then
        echo "‚ö†Ô∏è  –ü–æ—Ä—Ç $port –∑–∞–Ω—è—Ç. –û—Å–≤–æ–±–æ–∂–¥–∞—é..."
        lsof -ti:$port | xargs kill -9 2>/dev/null || true
        sleep 1
        echo "‚úÖ –ü–æ—Ä—Ç $port –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω"
    fi
}

check_db() {
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
    if php artisan db:show >/dev/null 2>&1; then
        echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL —É—Å–ø–µ—à–Ω–æ"
        return 0
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ .env —Ñ–∞–π–ª–µ"
        return 1
    fi
}

case "${1:-start}" in
    start)
        kill_port $LARAVEL_PORT "Laravel"
        kill_port $VITE_PORT "Vite"
        
        if ! check_db; then
            exit 1
        fi
        
        echo "üîß –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞..."
        php artisan optimize:clear >/dev/null 2>&1
        
        echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
        if [ ! -d "node_modules" ]; then
            npm install
        fi
        
        echo "üöÄ –ó–∞–ø—É—Å–∫ Laravel (–ø–æ—Ä—Ç $LARAVEL_PORT)..."
        php artisan serve --port=$LARAVEL_PORT > "$LARAVEL_LOG" 2>&1 &
        LARAVEL_PID=$!
        echo $LARAVEL_PID > .laravel.pid
        
        echo "‚ö° –ó–∞–ø—É—Å–∫ Vite (–ø–æ—Ä—Ç $VITE_PORT)..."
        npm run dev > "$VITE_LOG" 2>&1 &
        VITE_PID=$!
        echo $VITE_PID > .vite.pid
        
        sleep 2
        
        if ps -p $LARAVEL_PID > /dev/null && ps -p $VITE_PID > /dev/null; then
            echo ""
            echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
            echo "üìç Laravel: http://localhost:$LARAVEL_PORT"
            echo "‚ö° Vite: http://localhost:$VITE_PORT"
            echo ""
            echo "üìã –õ–æ–≥–∏:"
            echo "   Laravel: tail -f $LARAVEL_LOG"
            echo "   Vite: tail -f $VITE_LOG"
            echo ""
            echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ./start stop"
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏."
            exit 1
        fi
        ;;
        
    stop)
        echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
        
        if [ -f .laravel.pid ]; then
            LARAVEL_PID=$(cat .laravel.pid)
            if ps -p $LARAVEL_PID > /dev/null 2>&1; then
                kill $LARAVEL_PID 2>/dev/null || true
                echo "‚úÖ Laravel –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            fi
            rm -f .laravel.pid
        fi
        
        if [ -f .vite.pid ]; then
            VITE_PID=$(cat .vite.pid)
            if ps -p $VITE_PID > /dev/null 2>&1; then
                kill $VITE_PID 2>/dev/null || true
                echo "‚úÖ Vite –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            fi
            rm -f .vite.pid
        fi
        
        kill_port $LARAVEL_PORT "Laravel"
        kill_port $VITE_PORT "Vite"
        
        echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        ;;
        
    restart)
        $0 stop
        sleep 2
        $0 start
        ;;
        
    status)
        echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞:"
        echo ""
        
        if [ -f .laravel.pid ] && ps -p $(cat .laravel.pid) > /dev/null 2>&1; then
            echo "‚úÖ Laravel: –∑–∞–ø—É—â–µ–Ω (PID: $(cat .laravel.pid))"
            echo "   http://localhost:$LARAVEL_PORT"
        else
            echo "‚ùå Laravel: –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
        
        if [ -f .vite.pid ] && ps -p $(cat .vite.pid) > /dev/null 2>&1; then
            echo "‚úÖ Vite: –∑–∞–ø—É—â–µ–Ω (PID: $(cat .vite.pid))"
            echo "   http://localhost:$VITE_PORT"
        else
            echo "‚ùå Vite: –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
        
        echo ""
        check_db
        ;;
        
    logs)
        if [ "$2" = "vite" ]; then
            tail -f "$VITE_LOG"
        else
            tail -f "$LARAVEL_LOG"
        fi
        ;;
        
    *)
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./start {start|stop|restart|status|logs [laravel|vite]}"
        exit 1
        ;;
esac
